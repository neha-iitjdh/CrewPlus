name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # Check PR Size
  # ============================================
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum += $2} END {print sum}')
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "Changes: +$ADDITIONS -$DELETIONS (Total: $TOTAL lines)"

          if [ $TOTAL -gt 1000 ]; then
            echo "::warning::Large PR detected! Consider breaking into smaller PRs."
          fi

  # ============================================
  # Conventional Commits Check
  # ============================================
  commit-lint:
    name: Commit Message Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "Checking commit messages follow conventional format..."
          git log --format='%s' origin/${{ github.base_ref }}..HEAD | while read msg; do
            if ! echo "$msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
              echo "::warning::Commit message doesn't follow conventional format: $msg"
            fi
          done
          echo "Commit message check complete!"

  # ============================================
  # Code Quality
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for console.log statements
        run: |
          if grep -r "console\.log" --include="*.js" --include="*.jsx" server/src client/src 2>/dev/null | grep -v "// eslint-disable" | head -20; then
            echo "::warning::Found console.log statements. Consider removing before merge."
          fi

      - name: Check for TODO comments
        run: |
          if grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.js" --include="*.jsx" server/src client/src 2>/dev/null | head -20; then
            echo "::notice::Found TODO/FIXME comments in code."
          fi

      - name: Check for hardcoded secrets
        run: |
          if grep -rE "(password|secret|api_key|apikey)\s*[=:]\s*['\"][^'\"]+['\"]" --include="*.js" --include="*.jsx" server/src client/src 2>/dev/null | grep -v "\.env" | head -10; then
            echo "::error::Potential hardcoded secrets found!"
            exit 1
          fi
          echo "No hardcoded secrets detected."
